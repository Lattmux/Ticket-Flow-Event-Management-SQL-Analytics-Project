--- Creating the database and tables 
CREATE DATABASE TICKETFLOW_DB;

Create table Attendees(
attendee_id INT PRIMARY KEY,
full_name VARCHAR(50),
city VARCHAR(50),
age INT
);

Create table events(
event_id int PRIMARY KEY,
event_tittle VARCHAR (100),
category VARCHAR(50),
ticket_price decimal (10,2)
);

create table Bookings (
Booking_id INT PRIMARY KEY,
attendee_id INT,
event_id INT,
rating INT,
attendee_status VARCHAR(20),
Foreign key (attendee_id) references attendees(attendee_id),
foreign key(event_id) references events(event_id)
);

--- Inserting data into the created tables
insert into attendees VALUES
(1, 'Harith Akintunde', 'Ibadan', 25),
(2, 'Alabi Oluwajare', 'Ikeja', 28),
(3, 'James Akinduro', 'Ilorin', 32),
(4, 'Abdullahi Lawal', 'Olomoda', 29),
(5, 'Danjuma Soko', 'Minna', 32),
(6, 'Asikolaye Maryam', 'Abeokuta', 22);

insert into events Values
(101, 'Tech Summit 2025', 'Technology', 150),
(102, 'Music Concer', 'entertainment', 100),
(103, 'Birthday', 'entertainment', 75),
(104, 'Global marketing Expo', 'Business', 200),
(105, 'Yoga for Beginners', 'Health', 80);

Insert into Bookings VALUES
(1, 1, 101, 5,'attended'),
(2, 2, 101, 4, 'attended'),
(3, 3, 102, 5, 'attended'),
(4, 1, 103, 3, 'missed'),
(5, 4, 104, 5, 'attended'),
(6, 5, 101, 4, 'attended'),
(7, 2, 103, 2, 'attended'),
(8, 3, 102, 3, 'attended');


---1. Analysing popularity of the event( Total Bookings)
select e.event_tittle, count(b.Booking_id) as total_bookings
from events e
left join Bookings b on e.event_id = b.event_id
group by e.event_tittle
order by total_bookings Desc;


---2. Analyze average rating by event category
SELECT 
category,
AVG(rating) as avg_feeback
FROM events as  e
JOIN Bookings as b 
on e.event_id = b.event_id
where b.attendee_status = 'attended'
group by category;


---3. Identify 'Super fans' i.e Attendees with multiple bookings
select
a.full_name,
count(b.booking_id) as event_booked
from attendees as a
join Bookings as b
on a.attendee_id = b.attendee_id
group by a.full_name 
having count(b.booking_id) > 1;


---4. Calculte total revenue generated by each event
select
e.event_tittle,
e.ticket_price * count(b.Booking_id) as total_revenue
from events as e 
join Bookings as b
on e.event_id = b.event_id
group by event_tittle, e.ticket_price;


---5 Determine the top performing events across all categories
select 
category,
event_tittle, avg_rating
from (
	select e.category, e.event_tittle,
	AVG(b.rating) as avg_rating,
	rank() over (partition by e.category
	order by avg(b.rating) desc) as rnk
	from events as e 
	join Bookings as b 
	on e.event_id = b.event_id
	group by e.category, e.event_tittle
	) t
	where rnk = 1;

	
---6. Create a ranking table that shows the number of events each attendees attended and their avaerage ratings.
select a.full_name, 
	  count(b.event_id) as number_of_events_attended,
	  avg(b.rating) as avg_rating
From attendees as a 
join Bookings as b
on a.attendee_id = b.attendee_id
where b.attendee_status = 'attended'
group by a.full_name
order by number_of_events_attended desc, avg_rating desc;


--7 Identify attendees who went to the most expensive events
Select a.full_name, e.event_tittle, e.ticket_price
From attendees as a
Join Bookings as b
on a.attendee_id = b.attendee_id
Join events as e on b.event_id = e.event_id
Where e.ticket_price = (Select max(ticket_price) from events)
	and b.attendee_status = 'attended';


---8.identify the % events booked but not showing up (missed)
select e.event_tittle, count(b.Booking_id) as total_bookings,
		sum(case when b.attendee_status = 'missed' then 1 else 0 end) as missed_count,
		cast(sum(case when b.attendee_status = 'missed' then 1 else 0 end) as decimal(5,2))
		/ count(b.booking_id) *100 as no_show_percentage
	from events as e
	join Bookings as b on e.event_id = b.event_id
	group by event_tittle
	having count(b.booking_id) > 1
	order by no_show_percentage desc;